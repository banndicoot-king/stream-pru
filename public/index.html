<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="icon"
      type="image/x-icon"
      href="https://static.ajayos.in/favicon/favicon.ico"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéµ Live Audio Streaming</title>
    <style>
      :root {
        --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-bg: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --tertiary-bg: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --success-bg: linear-gradient(135deg, #00ff88 0%, #00e676 100%);
        --warning-bg: linear-gradient(135deg, #ffb800 0%, #ffa726 100%);
        --error-bg: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
        --dark-bg: #1a1a2e;
        --darker-bg: #16213e;
        --darkest-bg: #0f172a;
        --accent-color: #00d4ff;
        --success-color: #00ff88;
        --warning-color: #ffb800;
        --error-color: #ff4757;
        --accent-hover-color: #764ba2;
        --info-color: #7c4dff;
        --text-primary: #ffffff;
        --text-secondary: #94a3b8;
        --text-muted: #64748b;
        --border-color: #334155;
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --shadow-sm: 0 4px 16px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.3);
        --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--darkest-bg);
        color: var(--text-primary);
        height: 100vh;
        display: flex;
        overflow: hidden;
      }

      .left-panel {
        width: 300px;
        background: var(--darker-bg);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg);
      }

      .header {
        padding: 16px;
        background: var(--darkest-bg);
        border-bottom: 1px solid var(--border-color);
        position: relative;
      }

      .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--darkest-bg);
        backdrop-filter: blur(10px);
        z-index: 1;
      }

      .header-content {
        position: relative;
        z-index: 2;
      }

      .header h1 {
        font-size: 15px;
        font-weight: 800;
        margin-bottom: 6px;
        background: linear-gradient(45deg, #ffffff, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--error-color);
        box-shadow: 0 0 8px rgba(255, 71, 87, 0.5);
        transition: all 0.3s ease;
      }

      .status-dot.connected {
        background: var(--success-color);
        box-shadow: 0 0 12px rgba(0, 255, 136, 0.5);
      }

      .status-dot2 {
        width: 12px;
        height: 10px;
        border-radius: 50%;
        background: var(--text-muted);
      }
      .status-dot2.disconnected {
        background: var(--error-color);
        box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
      }
      .status-dot2.connected {
        background: var(--success-color);
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
      }
      .status-dot2.inDot {
        background: var(--warning-color);
        box-shadow: 0 0 10px rgba(213, 248, 12, 0.5);
      }
      .status-dot2.audio {
        background: rgb(0, 174, 255);
        box-shadow: 0 0 10px rgba(0, 174, 255, 0.5);
      }
      .status-dot2.outDot {
        background: var(--accent-color);
        box-shadow: 0 0 10px var(--accent-color);
      }
      .io-dots {
        display: flex;
        gap: 8px;
        margin-left: 16px;
      }
      .io-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--text-muted);
        opacity: 0.6;
        transition: all 0.2s;
      }
      .io-dot.in.active {
        background: var(--success-color);
        opacity: 1;
        box-shadow: 0 0 10px var(--success-color);
      }
      .io-dot.out.active {
        background: var(--accent-color);
        opacity: 1;
        box-shadow: 0 0 10px var(--accent-color);
      }

      .audio-status {
        font-size: 13px;
        margin-top: 8px;
        color: var(--text-secondary);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      .audio-player-container {
        padding: 10px;
      }
      audio {
        width: 100%;
        outline: none;
        margin-top: 6px;
      }

      .controls-section {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
      }

      .section-title {
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .settings-icon {
        cursor: pointer;
        font-size: 16px;
        transition: transform 0.3s ease;
      }

      .settings-icon:hover {
        transform: rotate(90deg);
      }

      .room-toggle {
        background: var(--tertiary-bg);
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 16px;
        font-size: 12px;
        font-weight: 600;
        width: 100%;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
      }

      .room-toggle:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .room-toggle::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .room-toggle:hover::before {
        left: 100%;
      }

      .stream-select {
        width: 100%;
        padding: 12px;
        background: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .stream-select:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
      }

      .file-upload-section {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
      }

      .file-input-wrapper {
        position: relative;
        margin-bottom: 12px;
      }

      .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-input-display {
        background: var(--dark-bg);
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .file-input-display:hover {
        border-color: var(--accent-color);
        background: rgba(0, 212, 255, 0.05);
      }

      .file-input-display.has-file {
        border-color: var(--success-color);
        background: rgba(0, 255, 136, 0.05);
      }

      .file-icon {
        font-size: 24px;
        margin-bottom: 8px;
        display: block;
      }

      .file-text {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }

      .file-name {
        font-size: 11px;
        color: var(--accent-color);
        font-weight: 600;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .action-btn.clear {
        background: var(--warning-bg);
        color: var(--darkest-bg);
      }

      .action-btn.stop {
        background: var(--success-bg);
        color: var(--darkest-bg);
      }

      .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .stats-compact {
        flex: 1;
      }

      .stats-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding: 8px 12px;
        background: var(--glass-bg);
        border-radius: 8px;
        border: 2px solid transparent;
        position: relative;
        cursor: pointer;
        transition: all 0.25s ease;
        overflow: hidden;
      }

      @keyframes blink-border {
        0% {
          border-color: var(--accent-color);
          box-shadow: 0 0 6px var(--accent-color);
        }
        50% {
          border-color: var(--accent-hover-color);
          box-shadow: 0 0 14px var(--accent-hover-color);
        }
        100% {
          border-color: var(--accent-color);
          box-shadow: 0 0 6px var(--accent-color);
        }
      }

      .stats-row::after {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: var(--accent-hover-color);
        transform: scaleY(0);
        transform-origin: top;
        transition: transform 0.3s ease;
        border-radius: 3px;
      }

      .stats-row:hover {
        background: var(--glass-hover-bg);
        transform: translateY(-2px);
        animation: blink-border 1.2s infinite alternate;
      }

      .stats-row:hover::after {
        transform: scaleY(1);
      }

      .stat-compact-label {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-compact-value {
        font-size: 14px;
        font-weight: 700;
        color: var(--accent-color);
        text-align: right;
      }

      .stat-compact-label:hover {
        color: var(--accent-hover-color);
      }

      .current-stream-compact {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        padding: 12px;
        margin-top: 12px;
        text-align: center;
      }

      .current-stream-label {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .current-stream-name {
        font-size: 12px;
        font-weight: 600;
        color: var(--accent-color);
      }

      .stream-action-buttons {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: 6px;
      }

      .stream-btn {
        padding: 5px 12px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.25s ease, background 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      }

      .stream-btn.clear {
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        color: #fff;
      }
      .stream-btn.clear:hover:not(:disabled) {
        background: linear-gradient(135deg, #fda085 0%, #f6d365 100%);
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 4px 10px rgba(253, 160, 133, 0.4);
      }

      .stream-btn.done {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
      }
      .stream-btn.done:hover:not(:disabled) {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 4px 12px rgba(118, 75, 162, 0.45);
      }

      .stream-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .right-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--dark-bg);
        overflow: hidden;
      }

      .stats-section2 {
        padding: 10px;
        background: var(--darker-bg);
        border-bottom: 2px solid var(--border-color);
        box-shadow: var(--shadow-sm);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .console-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .console-header {
        height: 60px;
        background: var(--darker-bg);
        border-bottom: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        box-shadow: var(--shadow-sm);
      }

      .console-tabs {
        display: flex;
        gap: 24px;
      }

      .console-tab {
        padding: 8px 0;
        cursor: pointer;
        color: var(--text-muted);
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .console-tab.active {
        color: var(--accent-color);
        border-bottom-color: var(--accent-color);
      }

      .console-tab:hover:not(.active) {
        color: var(--text-primary);
      }

      .console-actions {
        display: flex;
        gap: 8px;
      }

      .console-btn {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-secondary);
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-size: 12px;
        font-weight: 500;
      }

      .console-btn:hover {
        background: var(--glass-border);
        color: var(--text-primary);
        transform: translateY(-1px);
      }

      .console-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
        font-family: "JetBrains Mono", "Fira Code", monospace;
        font-size: 13px;
        line-height: 1.5;
        background: var(--darkest-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin: 16px;
        box-shadow: var(--shadow-lg);
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 10px 12px;
        border-radius: 6px;
        border-left: 3px solid transparent;
        animation: slideIn 0.3s ease;
        transition: all 0.2s ease;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
      }

      .log-entry:hover {
        transform: translateX(2px);
        box-shadow: var(--shadow-sm);
      }

      .log-entry.info {
        border-left-color: var(--info-color);
        background: rgba(124, 77, 255, 0.1);
      }
      .log-entry.success {
        border-left-color: var(--success-color);
        background: rgba(0, 255, 136, 0.1);
      }
      .log-entry.warning {
        border-left-color: var(--warning-color);
        background: rgba(255, 184, 0, 0.1);
      }
      .log-entry.error {
        border-left-color: var(--error-color);
        background: rgba(255, 71, 87, 0.1);
      }
      .log-entry.audio {
        border-left-color: var(--accent-color);
        background: rgba(0, 212, 255, 0.1);
      }
      .log-entry.websocket {
        border-left-color: #8fff0e;
        background: rgba(0, 255, 200, 0.1);
      }
      .log-entry.files {
        border-left-color: #ffc400;
        background: rgba(179, 255, 0, 0.1);
      }
      .log-entry.events {
        border-left-color: hsl(323, 80%, 51%);
        background: rgba(24, 245, 142, 0.1);
      }

      .log-timestamp {
        color: var(--text-muted);
        font-size: 11px;
        font-weight: 500;
      }

      .log-type {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 10px;
        margin-right: 8px;
        padding: 2px 6px;
        border-radius: 3px;
        letter-spacing: 0.5px;
      }

      .log-type.info {
        background: var(--info-color);
        color: white;
      }
      .log-type.success {
        background: var(--success-color);
        color: var(--darkest-bg);
      }
      .log-type.warning {
        background: var(--warning-color);
        color: var(--darkest-bg);
      }
      .log-type.error {
        background: var(--error-color);
        color: white;
      }
      .log-type.audio {
        background: var(--accent-color);
        color: var(--darkest-bg);
      }
      .log-type.websocket {
        background: #ff6b6b;
        color: white;
      }
      .log-type.files {
        background: #ff0080;
        color: white;
      }
      .log-type.events {
        background: #0afff3;
        color: white;
      }

      .log-message {
        color: var(--text-primary);
        font-weight: 500;
      }

      .log-data {
        margin-top: 6px;
        padding: 6px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 3px;
        font-size: 11px;
        color: var(--text-secondary);
        overflow-x: auto;
      }

      .room-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .room-popup-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .room-popup {
        position: fixed;
        bottom: -400px;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
        background: var(--darker-bg);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        box-shadow: var(--shadow-xl);
        z-index: 10000;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        overflow: hidden;
      }

      .room-popup.show {
        bottom: 50px;
        animation: ringAnimation 1s ease-in-out infinite;
      }

      @keyframes ringAnimation {
        0% {
          transform: translateX(-50%) scale(1);
        }
        10% {
          transform: translateX(-50%) scale(1.05) rotate(2deg);
        }
        20% {
          transform: translateX(-50%) scale(1) rotate(-2deg);
        }
        30% {
          transform: translateX(-50%) scale(1.05) rotate(2deg);
        }
        40% {
          transform: translateX(-50%) scale(1) rotate(0);
        }
        100% {
          transform: translateX(-50%) scale(1);
        }
      }

      .room-popup-header {
        background: var(--secondary-bg);
        padding: 16px 20px;
        position: relative;
      }

      .room-popup-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .room-popup-content {
        padding: 20px;
      }

      .room-request-info {
        margin-bottom: 20px;
      }

      .room-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--accent-color);
        margin-bottom: 8px;
        word-break: break-word;
      }

      .room-details {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .room-popup-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .room-popup-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
      }

      .room-popup-btn.accept {
        background: var(--success-color);
        color: var(--darkest-bg);
      }

      .room-popup-btn.accept:hover {
        background: #00e676;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
      }

      .room-popup-btn.decline {
        background: var(--glass-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .room-popup-btn.decline:hover {
        background: var(--error-color);
        border-color: var(--error-color);
        transform: translateY(-1px);
      }

      /* New popup for settings */
      .settings-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .settings-popup-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .settings-popup {
        position: fixed;
        bottom: -400px;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
        background: var(--darker-bg);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        box-shadow: var(--shadow-xl);
        z-index: 10000;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        overflow: hidden;
      }

      .settings-popup.show {
        bottom: 50px;
      }

      .settings-popup-header {
        background: var(--primary-bg);
        padding: 16px 20px;
        position: relative;
      }

      .settings-popup-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .settings-popup-content {
        padding: 20px;
      }

      .settings-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 16px;
        background: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
      }

      .settings-popup-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .settings-popup-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
      }

      .settings-popup-btn.submit {
        background: var(--success-color);
        color: var(--darkest-bg);
      }

      .settings-popup-btn.submit:hover {
        background: #00e676;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
      }

      .settings-popup-btn.cancel {
        background: var(--glass-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .settings-popup-btn.cancel:hover {
        background: var(--error-color);
        border-color: var(--error-color);
        transform: translateY(-1px);
      }

      .upload-progress {
        margin-top: 8px;
        height: 4px;
        background: var(--dark-bg);
        border-radius: 2px;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .upload-progress.show {
        opacity: 1;
      }

      .upload-progress-bar {
        height: 100%;
        background: var(--success-bg);
        width: 0%;
        transition: width 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      .hidden {
        display: none !important;
      }

      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: var(--darkest-bg);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(
          135deg,
          var(--accent-color),
          var(--info-color)
        );
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(
          135deg,
          var(--info-color),
          var(--accent-color)
        );
      }

      @media (max-width: 768px) {
        .left-panel {
          width: 100%;
          max-width: 280px;
        }
        .room-popup {
          width: 90%;
          max-width: 350px;
        }
        .room-popup-actions {
          flex-direction: column;
        }
        .room-popup-btn {
          width: 100%;
        }
        .settings-popup {
          width: 90%;
          max-width: 350px;
        }
        .settings-popup-actions {
          flex-direction: column;
        }
        .settings-popup-btn {
          width: 100%;
        }
      }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  </head>
  <body>
    <div class="left-panel">
      <div class="header">
        <div class="header-content">
          <div class="status-indicator">
            <div class="status-dot" id="connectionStatus"></div>
            <span id="statusText">Disconnected</span>
            <div class="io-dots">
              <div class="status-dot2" id="connectionStatus2"></div>
              <div class="io-dot in" id="inDot"></div>
              <div class="io-dot out" id="outDot"></div>
            </div>
          </div>
          <div class="audio-status" id="audioStatus">üîá Not Playing</div>
        </div>
      </div>

      <div class="controls-section">
        <div class="section-title">üéÆ Room Control</div>
        <button
          class="room-toggle"
          onclick="toggleRoomCreation()"
          id="toggleRoomCreation"
        >
          üéØ Enable Room Creation
        </button>

        <div class="section-title">üìª Available Streams</div>
        <select class="stream-select" id="streamSelect">
          <option value="">Select a stream üéß</option>
        </select>

        <div class="stats-compact">
          <div class="current-stream-compact">
            <div class="current-stream-label">üé∂ Current Stream</div>
            <div class="current-stream-name" id="currentStreamName">
              No stream selected
            </div>

            <div class="stream-action-buttons">
              <button
                class="stream-btn clear"
                id="clearStreamBtn"
                onclick="clearSelectedStream()"
                disabled
              >
                üóëÔ∏è Clear
              </button>
              <button
                class="stream-btn done"
                id="stopStreamBtn"
                onclick="sendStopSelectedStream()"
                disabled
              >
                ‚èπÔ∏è Stop
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="file-upload-section">
        <div class="section-title">
          üìÇ File Upload
          <span class="settings-icon" onclick="openUploadSettings()">‚öôÔ∏è</span>
        </div>
        <div class="file-input-wrapper">
          <input
            type="file"
            class="file-input"
            id="fileInput"
            accept="audio/*,.mp3,.wav,.ogg,.flac,.m4a"
            multiple
          />
          <div class="file-input-display" id="fileInputDisplay">
            <span class="file-icon">üéµ</span>
            <div class="file-text">Click to select audio files üé§</div>
            <div class="file-name" id="fileName"></div>
          </div>
          <div class="upload-progress" id="uploadProgress">
            <div class="upload-progress-bar" id="uploadProgressBar"></div>
          </div>
        </div>
        <div class="action-buttons">
          <button
            class="action-btn clear"
            onclick="clearFileSelection()"
            id="clearBtn"
            disabled
          >
            üóëÔ∏è Clear
          </button>
          <button
            class="action-btn done"
            onclick="uploadFiles()"
            id="doneBtn"
            disabled
          >
            üöÄ Upload
          </button>
        </div>

        <div class="audio-player-container">
          <audio id="player" autoplay></audio>
        </div>

        <audio id="callTone" autoplay muted loop>
          <source
            src="https://github.com/ajay-o-s/static-assets/raw/refs/heads/master/audio/stream/bell.mp3"
            type="audio/mpeg"
          />
        </audio>
      </div>
    </div>

    <div class="right-panel">
      <div class="stats-section2">
        <div class="stats-row">
          <span class="stat-compact-label">üì° Active Streams&nbsp;&nbsp;</span>
          <span class="stat-compact-value" id="streamCount">&nbsp;0&nbsp;</span>
        </div>
        <div class="stats-row">
          <span class="stat-compact-label">üí¨ Total Messages&nbsp;&nbsp;</span>
          <span class="stat-compact-value" id="messageCount"
            >&nbsp;0&nbsp;</span
          >
        </div>
        <div class="stats-row">
          <span class="stat-compact-label">üéµ Audio Packets&nbsp;&nbsp;</span>
          <span class="stat-compact-value" id="audioPackets"
            >&nbsp;0&nbsp;</span
          >
        </div>
        <div class="stats-row">
          <span class="stat-compact-label"
            >üåê WebSocket Messages&nbsp;&nbsp;</span
          >
          <span class="stat-compact-value" id="wsMessages">&nbsp;0&nbsp;</span>
        </div>
        <div class="stats-row">
          <span class="stat-compact-label">üì§ Files Uploaded&nbsp;&nbsp;</span>
          <span class="stat-compact-value" id="fileUploadCount"
            >&nbsp;0&nbsp;</span
          >
        </div>
        <div class="stats-row"></div>
        <div class="stats-row"></div>
      </div>
      <div class="console-section">
        <div class="console-header">
          <div class="console-tabs">
            <div
              class="console-tab active"
              data-tab="events"
              onclick="switchTab('events')"
            >
              üìÖ Events
            </div>
            <div
              class="console-tab"
              data-tab="websocket"
              onclick="switchTab('websocket')"
            >
              üåê WebSocket
            </div>
            <div
              class="console-tab"
              data-tab="audio"
              onclick="switchTab('audio')"
            >
              üéß Audio
            </div>
            <div
              class="console-tab"
              data-tab="files"
              onclick="switchTab('files')"
            >
              üìÇ Files
            </div>
          </div>
          <div class="console-actions">
            <button class="console-btn" onclick="clearConsole()">
              üóëÔ∏è Clear
            </button>
            <button class="console-btn" onclick="exportLogs()">
              üíæ Export
            </button>
          </div>
        </div>
        <div class="console-content" id="consoleContent"></div>
      </div>
    </div>

    <div class="room-popup-overlay" id="roomPopupOverlay">
      <div class="room-popup" id="roomPopup">
        <div class="room-popup-header">
          <h3 class="room-popup-title">üìû Incoming Streaming Request</h3>
        </div>
        <div class="room-popup-content">
          <div class="room-request-info">
            <div class="room-name" id="roomPopupName">Room Name</div>
            <div class="room-details" id="roomPopupDetails">
              A new audio streaming room has been requested.
            </div>
          </div>
          <div class="room-popup-actions">
            <button class="room-popup-btn decline" onclick="dismissRoomPopup()">
              ‚ùå Decline
            </button>
            <button class="room-popup-btn accept" onclick="acceptRoomRequest()">
              ‚úÖ Accept
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="settings-popup-overlay" id="uploadSettingsOverlay">
      <div class="settings-popup" id="uploadSettingsPopup">
        <div class="settings-popup-header">
          <h3 class="settings-popup-title">‚öôÔ∏è Upload Settings</h3>
        </div>
        <div class="settings-popup-content">
          <label for="packetSize">Packet Size (KB):</label>
          <input
            type="number"
            id="packetSize"
            class="settings-input"
            value="64"
            min="1"
          />
          <div class="settings-popup-actions">
            <button
              class="settings-popup-btn cancel"
              onclick="dismissUploadSettings()"
            >
              ‚ùå Cancel
            </button>
            <button
              class="settings-popup-btn submit"
              onclick="submitUploadSettings()"
            >
              ‚úÖ Submit
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Application State
      let messageCount = 0;
      let audioPacketCount = 0;
      let wsMessageCount = 0;
      let fileUploadCount = 0;
      let currentTab = "events";
      let logs = { events: [], websocket: [], audio: [], files: [] };
      let selectedFiles = [];
      let currentStream = null;
      let rooms = [];
      let ws = null;
      let currentRoomRequest = null;
      let popupTimeout = null;
      let mediaSource = null;
      let sourceBuffer = null;
      let audioQueue = [];
      let isBuffering = false;
      let isPlaying = false;
      let chunkSize = 64 * 1024; // Default chunk size

      // DOM Elements
      const streamList = document.getElementById("streamSelect");
      const statusIndicator = document.getElementById("connectionStatus");
      const statusIndicator2 = document.getElementById("connectionStatus2");
      const statusText = document.getElementById("statusText");
      const currentStreamName = document.getElementById("currentStreamName");
      const clearStreamBtn = document.getElementById("clearStreamBtn");
      const doneStreamBtn = document.getElementById("stopStreamBtn");
      const audioElement = document.getElementById("player");
      const audioStatus = document.getElementById("audioStatus");
      const fileInput = document.getElementById("fileInput");

      // Audio Event Listeners
      audioElement.addEventListener("play", () => {
        audioStatus.textContent = "üéµ Playing Audio";
        blinkDot2("audio");
      });
      audioElement.addEventListener("pause", () => {
        audioStatus.textContent = "‚è∏Ô∏è Paused";
      });
      audioElement.addEventListener("ended", () => {
        audioStatus.textContent = "üîá Ended";
      });

      // Initialize WebSocket connection
      function initializeWebSocket() {
        const url = ["localhost", "127.0.0.1"].includes(
          window.location.hostname
        )
          ? "wss://stream.ajayos.in/?ptpl=Ptpl123"
          : window.location.protocol.replace("http", "ws") +
            "//" +
            window.location.host +
            "?ptpl=Ptpl123";

        ws = new WebSocket(url);
        console.log(`üåê WebSocket connecting to: ${url}`);

        ws.onopen = () => {
          logToConsole(
            "success",
            "‚úÖ WebSocket connection established",
            null,
            "events"
          );
          logToConsole(
            "websocket",
            "üåê Connection opened",
            { event: "open" },
            "websocket"
          );
          updateConnectionStatus(true);
          blinkIODot("out");

          const userId = Math.random().toString(36).substr(2, 9);
          const registerMsg = {
            type: "register-user",
            id: userId,
            name: "Professional Client",
          };
          sendWebSocketMessage(registerMsg);
          logToConsole(
            "info",
            `üë§ Registered as user: ${userId}`,
            null,
            "events"
          );
        };

        ws.onmessage = (event) => {
          try {
            const { type, ...message } = JSON.parse(event.data);
            blinkIODot("in");
            logToConsole(
              "websocket",
              `üì• Received: ${type}`,
              { type, ...message },
              "websocket"
            );

            handleWebSocketMessage(type, message);
          } catch (error) {
            logToConsole(
              "error",
              `‚ùå Failed to parse message: ${error.message}`,
              { error: error.message, raw: event.data },
              "websocket"
            );
          }
        };

        ws.onerror = (error) => {
          logToConsole(
            "error",
            "‚ùå WebSocket connection error",
            error,
            "events"
          );
          logToConsole(
            "websocket",
            "‚ùå WebSocket error",
            { error },
            "websocket"
          );
          updateConnectionStatus(false);
        };

        ws.onclose = (e) => {
          logToConsole(
            "warning",
            "‚ö†Ô∏è WebSocket connection closed",
            { code: e.code, reason: e.reason },
            "events"
          );
          logToConsole(
            "websocket",
            "üåê Connection closed",
            { code: e.code, reason: e.reason },
            "websocket"
          );
          updateConnectionStatus(false);
        };
      }

      // call tone play
      function playCallTone() {
        const audio = document.getElementById("callTone");
        audio.muted = false;
      }

      // call tone stop
      function stopCallTone() {
        const audio = document.getElementById("callTone");
        audio.muted = true;
        audio.currentTime = 0; // rewind
      }

      // Handle WebSocket messages
      function handleWebSocketMessage(type, message) {
        switch (type) {
          case "add-stream":
            rooms = [...rooms, ...message.stream];
            message.stream.forEach((room) => {
              if (room.id === undefined) {
                room.id = room.roomId;
                showRoomRequestPopup({
                  ...room,
                  requester: room.requester || "Anonymous User",
                  timestamp: new Date().toISOString(),
                });
              }
            });
            updateStreamList();
            logToConsole(
              "success",
              `‚úÖ Added ${message.stream.length} stream(s)`,
              message.stream,
              "events"
            );
            break;

          case "remove-stream":
            const roomId = message.stream[0].roomId;
            rooms = rooms.filter((room) => room.id !== roomId);
            if (currentStream === roomId) {
              stopStreaming();
            }
            updateStreamList();
            logToConsole(
              "warning",
              `‚ö†Ô∏è Removed stream: ${roomId}`,
              null,
              "events"
            );
            break;

          case "audio-chunk":
            logToConsole(
              "audio",
              "üéµ Audio chunk received",
              {
                size: message.chunk.data
                  ? message.chunk.data.length
                  : "unknown",
                type: message.chunk.type || "standard",
              },
              "audio"
            );
            handleAudioChunk(message.chunk);
            break;

          case "audio-chunk2":
            logToConsole(
              "audio",
              "üéß PCM audio chunk received",
              {
                format: "PCM 16kHz",
                size: message.chunk.data
                  ? message.chunk.data.length
                  : "unknown",
              },
              "audio"
            );
            handlePCMAudioChunk(message.chunk);
            break;

          case "file-upload-response":
            logToConsole(
              "files",
              "üì§ File upload response received",
              message,
              "files"
            );
            handleFileUploadResponse(message);
            break;

          case "error":
            logToConsole(
              "error",
              `‚ùå Server error: ${message.error}`,
              message,
              "events"
            );
            showToast(`‚ùå Server error: ${message.error}`, "error");
            break;

          default:
            logToConsole(
              "info",
              `‚ÑπÔ∏è Unknown message type: ${type}`,
              message,
              "events"
            );
        }
      }

      // Send WebSocket message
      function sendWebSocketMessage(message, isJson = true) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(isJson ? JSON.stringify(message) : message);
          blinkIODot("out");
          logToConsole(
            "websocket",
            `üì§ Sent: ${message.type}`,
            message,
            "websocket"
          );
          return true;
        } else {
          logToConsole("error", "‚ùå WebSocket not connected", null, "events");
          showToast("‚ùå WebSocket not connected", "error");
          return false;
        }
      }

      // Update connection status
      function updateConnectionStatus(connected) {
        if (connected) {
          statusIndicator.classList.add("connected");
          statusIndicator2.classList.add("connected");
          statusText.textContent = "Connected";
        } else {
          statusIndicator.classList.remove("connected");
          statusIndicator2.classList.add("disconnected");
          statusText.textContent = "Disconnected";
        }
      }

      // Blink I/O dots
      function blinkIODot(direction) {
        const dot = document.getElementById(
          direction === "in" ? "inDot" : "outDot"
        );
        dot.classList.add("active");
        blinkDot2(direction === "in" ? "inDot" : "outDot");
        setTimeout(() => dot.classList.remove("active"), 300);
      }

      function blinkDot2(dotId) {
        statusIndicator2.classList.forEach((cls) => {
          if (cls !== "status-dot2") {
            statusIndicator2.classList.remove(cls);
          }
        });
        statusIndicator2.classList.add(dotId);
        setTimeout(() => statusIndicator2.classList.remove(dotId), 300);
      }

      // Logging system
      function logToConsole(type, message, data = null, tab = "events") {
        messageCount++;
        document.getElementById("messageCount").textContent = messageCount;

        if (tab === "audio") {
          audioPacketCount++;
          document.getElementById("audioPackets").textContent =
            audioPacketCount;
        } else if (tab === "websocket") {
          wsMessageCount++;
          document.getElementById("wsMessages").textContent = wsMessageCount;
        } else if (tab === "files") {
          fileUploadCount++;
          document.getElementById("fileUploadCount").textContent =
            fileUploadCount;
        }

        const now = new Date();
        const timestamp = `${now.toLocaleTimeString()}.${now
          .getMilliseconds()
          .toString()
          .padStart(3, "0")}`;

        const logEntry = { timestamp, type, message, data };
        logs[tab].push(logEntry);

        if (currentTab === tab) {
          renderLogEntry(logEntry);
        }
      }

      // Render log entry
      function renderLogEntry(logEntry) {
        const consoleContent = document.getElementById("consoleContent");
        const logDiv = document.createElement("div");
        logDiv.className = `log-entry ${logEntry.type}`;

        let logData = "";
        if (logEntry.data) {
          logData = `<div class="log-data">${JSON.stringify(
            logEntry.data,
            null,
            2
          )}</div>`;
        }

        logDiv.innerHTML = `
          <span class="log-timestamp">${logEntry.timestamp}</span>
          <span class="log-type ${logEntry.type}">${logEntry.type}</span>
          <span class="log-message">${logEntry.message}</span>
          ${logData}
        `;

        consoleContent.appendChild(logDiv);
        consoleContent.scrollTop = consoleContent.scrollHeight;
      }

      // Switch console tabs
      function switchTab(tab) {
        currentTab = tab;
        document
          .querySelectorAll(".console-tab")
          .forEach((t) => t.classList.remove("active"));
        document.querySelector(`[data-tab="${tab}"]`).classList.add("active");

        const consoleContent = document.getElementById("consoleContent");
        consoleContent.innerHTML = "";
        logs[tab].forEach((log) => renderLogEntry(log));
      }

      // Clear console
      function clearConsole() {
        logs[currentTab] = [];
        document.getElementById("consoleContent").innerHTML = "";

        if (currentTab === "events") {
          messageCount = 0;
          document.getElementById("messageCount").textContent = "0";
        } else if (currentTab === "audio") {
          audioPacketCount = 0;
          document.getElementById("audioPackets").textContent = "0";
        } else if (currentTab === "websocket") {
          wsMessageCount = 0;
          document.getElementById("wsMessages").textContent = "0";
        } else if (currentTab === "files") {
          fileUploadCount = 0;
          document.getElementById("fileUploadCount").textContent = "0";
        }

        logToConsole(
          "info",
          `üßπ ${
            currentTab.charAt(0).toUpperCase() + currentTab.slice(1)
          } console cleared`,
          null,
          currentTab
        );
      }

      // Export logs
      function exportLogs() {
        const dataStr =
          "data:text/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(logs, null, 2));
        const downloadAnchorNode = document.createElement("a");
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute(
          "download",
          `console-logs-${new Date().toISOString()}.json`
        );
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        logToConsole(
          "success",
          "üíæ Logs exported successfully",
          null,
          "events"
        );
      }

      // Show toast notification
      function showToast(message, type = "info") {
        const bgColors = {
          success: "linear-gradient(135deg, #00ff88, #00e676)",
          warning: "linear-gradient(135deg, #ffb800, #ffa726)",
          error: "linear-gradient(135deg, #ff4757, #ff3742)",
          info: "linear-gradient(135deg, #667eea, #764ba2)",
        };

        Toastify({
          text: message,
          duration: 3000,
          backgroundColor: bgColors[type] || bgColors.info,
        }).showToast();
      }

      // Toggle room creation
      function toggleRoomCreation() {
        const button = document.getElementById("toggleRoomCreation");
        const isEnabled = button.textContent.includes("Disable");
        const status = isEnabled ? 0 : 1;

        button.textContent = isEnabled
          ? "üéØ Enable Room Creation"
          : "üéØ Disable Room Creation";

        fetch("/roomStart", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status }),
        })
          .then((response) => {
            if (!response.ok) {
              logToConsole(
                "error",
                "‚ùå Room creation toggle failed",
                response,
                "events"
              );
              showToast("‚ùå Error toggling room creation", "error");
              throw new Error("Network response was not ok");
            }
            logToConsole(
              "success",
              `‚úÖ Room creation ${
                status ? "enabled" : "disabled"
              } (server confirmed)`,
              null,
              "events"
            );
            showToast(
              `üéâ Room creation ${status ? "enabled" : "disabled"}`,
              status ? "success" : "warning"
            );
            return response.json();
          })
          .catch((error) => {
            button.textContent = isEnabled
              ? "üéØ Disable Room Creation"
              : "üéØ Enable Room Creation";
            logToConsole(
              "error",
              `‚ùå Room toggle error: ${error.message}`,
              null,
              "events"
            );
          });
      }

      // Update stream list
      // Update stream list incrementally
      function updateStreamList() {
        const streamCountEl = document.getElementById("streamCount");
        const streamCountTopEl = document.getElementById("streamCountTop");

        // Build a Set of current room IDs in <select>
        const existingIds = new Set(
          Array.from(streamList.options).map((opt) => opt.value)
        );

        // Add new rooms
        rooms.forEach((room) => {
          if (!existingIds.has(room.id)) {
            const option = document.createElement("option");
            option.value = room.id;
            option.textContent = room.name;
            streamList.appendChild(option);
          } else {
            // Update name if changed
            const option = Array.from(streamList.options).find(
              (opt) => opt.value === room.id
            );
            if (option && option.textContent !== room.name) {
              option.textContent = room.name;
            }
          }
          existingIds.delete(room.id); // Mark as handled
        });

        // Remove options that are no longer in rooms
        existingIds.forEach((id) => {
          if (id !== "") {
            const opt = streamList.querySelector(`option[value="${id}"]`);
            if (opt) opt.remove();
          }
        });

        // Update stream count
        streamCountEl.textContent = rooms.length;
        streamCountTopEl.textContent = rooms.length;

        // Restore selection if valid
        if (currentStream) {
          const option = streamList.querySelector(
            `option[value="${currentStream}"]`
          );
          if (option) {
            streamList.value = currentStream;
          } else {
            streamList.value = "";
            currentStream = null;
          }
        }
      }

      // Handle stream selection
      streamList.addEventListener("change", function () {
        const selectedStream = this.value;
        if (currentStream !== selectedStream) {
          if (currentStream) stopStreaming();
          currentStream = selectedStream;

          if (currentStream) {
            const selectedRoom = rooms.find(
              (room) => room.id === currentStream
            );
            currentStreamName.textContent = selectedRoom
              ? selectedRoom.name
              : "Unknown Stream";
            clearStreamBtn.disabled = false;
            doneStreamBtn.disabled = false;

            startStreaming();
            logToConsole(
              "info",
              `üéß Selected stream: ${selectedRoom?.name || "Unknown"}`,
              selectedRoom,
              "events"
            );
          } else {
            clearStreamBtn.disabled = true;
            doneStreamBtn.disabled = true;
            currentStreamName.textContent = "No stream selected";
            resetMediaSource();
          }
        }
      });

      // Start streaming
      function startStreaming() {
        if (!currentStream || !ws || ws.readyState !== WebSocket.OPEN) return;

        logToConsole(
          "info",
          `üé∂ Starting stream: ${currentStream}`,
          null,
          "events"
        );

        // Initialize MediaSource
        if (mediaSource) {
          mediaSource.endOfStream();
        }
        mediaSource = new MediaSource();
        audioElement.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener("sourceopen", () => {
          sourceBuffer = mediaSource.addSourceBuffer("audio/mpeg");
          sourceBuffer.addEventListener("updateend", () => {
            if (!isBuffering && audioQueue.length > 0) {
              appendToBuffer();
            }
          });
        });

        audioElement.oncanplay = () => {
          audioElement.play().catch((err) => {
            console.error("Error during playback:", err);
            logToConsole(
              "error",
              `‚ùå Playback error: ${err.message}`,
              null,
              "audio"
            );
          });
        };

        const joinMsg = { type: "join-room", roomId: currentStream };
        sendWebSocketMessage(joinMsg);
        logToConsole(
          "success",
          `‚úÖ Joined room: ${currentStream}`,
          null,
          "events"
        );
      }

      // Stop streaming
      function stopStreaming() {
        if (currentStream) {
          const leaveMsg = { type: "leave-room", roomId: currentStream };
          sendWebSocketMessage(leaveMsg);
          logToConsole(
            "info",
            `üëã Left room: ${currentStream}`,
            null,
            "events"
          );
          currentStream = null;
          clearStreamBtn.disabled = true;
          doneStreamBtn.disabled = true;
          currentStreamName.textContent = "No stream selected";
          resetMediaSource();
        }
      }

      // Reset MediaSource
      function resetMediaSource() {
        if (mediaSource) {
          mediaSource.endOfStream();
          mediaSource = null;
          sourceBuffer = null;
          audioQueue = [];
          isBuffering = false;
        }
      }

      // Handle audio chunk
      function handleAudioChunk(chunk) {
        if (chunk.type === "audio-buffer") {
          handleVoiceChunk(chunk.data);
        } else {
          const chunkData = new Uint8Array(chunk.data);
          audioQueue.push(chunkData);

          if (!sourceBuffer.updating && !isBuffering) {
            appendToBuffer();
          }
        }
      }

      // Append audio to buffer
      function appendToBuffer() {
        if (audioQueue.length > 0 && sourceBuffer && !sourceBuffer.updating) {
          const chunk = audioQueue.shift();
          isBuffering = true;
          sourceBuffer.appendBuffer(chunk);
          isBuffering = false;
        }
      }

      // Handle PCM audio chunk
      function handlePCMAudioChunk(chunk) {
        try {
          const binary = atob(chunk.data);
          const rawPCM = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            rawPCM[i] = binary.charCodeAt(i);
          }
          audioQueue.push(rawPCM);

          if (!isPlaying) {
            playNextChunk();
          }
          logToConsole(
            "audio",
            `üéµ Queued PCM16 chunk (${rawPCM.length} bytes)`,
            null,
            "audio"
          );
        } catch (err) {
          logToConsole(
            "error",
            `‚ùå PCM16 chunk processing failed: ${err.message}`,
            null,
            "audio"
          );
        }
      }

      // Convert PCM16 to WAV Blob
      function pcm16ToWavBlob(pcm16, options = {}) {
        const numChannels = options.numChannels || 1;
        const sampleRate = options.sampleRate || 16000;
        const bitsPerSample = options.bitsPerSample || 16;

        const byteRate = (sampleRate * numChannels * bitsPerSample) / 8;
        const blockAlign = (numChannels * bitsPerSample) / 8;

        const buffer = new ArrayBuffer(44);
        const view = new DataView(buffer);

        const writeString = (offset, str) => {
          for (let i = 0; i < str.length; i++)
            view.setUint8(offset + i, str.charCodeAt(i));
        };

        writeString(0, "RIFF");
        view.setUint32(4, 36 + pcm16.byteLength, true);
        writeString(8, "WAVE");
        writeString(12, "fmt ");
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true); // PCM
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitsPerSample, true);
        writeString(36, "data");
        view.setUint32(40, pcm16.byteLength, true);

        const wavBuffer = new Uint8Array(44 + pcm16.byteLength);
        wavBuffer.set(new Uint8Array(buffer), 0);
        wavBuffer.set(new Uint8Array(pcm16.buffer), 44);

        return new Blob([wavBuffer], { type: "audio/wav" });
      }

      // Play next audio chunk
      function playNextChunk() {
        if (audioQueue.length === 0) {
          isPlaying = false;
          return;
        }

        isPlaying = true;
        const chunk = audioQueue.shift();
        const wavBlob = pcm16ToWavBlob(chunk, {
          sampleRate: 8000,
          numChannels: 1,
          bitsPerSample: 16,
        });
        const url = URL.createObjectURL(wavBlob);
        audioElement.src = url;

        audioElement.play().catch((err) => {
          console.error("Audio play failed:", err);
          logToConsole(
            "error",
            `‚ùå Audio play failed: ${err.message}`,
            null,
            "audio"
          );
        });

        audioElement.onended = () => {
          URL.revokeObjectURL(url);
          playNextChunk();
        };
      }

      // Handle voice chunk
      function handleVoiceChunk(data) {
        const audioBlob = new Blob([new Uint8Array(data)], {
          type: "audio/webm",
        });
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.play();
        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
        };
      }

      // File handling
      fileInput.addEventListener("change", function (e) {
        selectedFiles = Array.from(e.target.files);
        updateFileDisplay();
        updateActionButtons();
        logToConsole(
          "files",
          `üìÇ Selected ${selectedFiles.length} file(s)`,
          selectedFiles.map((f) => ({
            name: f.name,
            size: f.size,
            type: f.type,
          })),
          "files"
        );
      });

      function updateFileDisplay() {
        const display = document.getElementById("fileInputDisplay");
        const fileName = document.getElementById("fileName");

        if (selectedFiles.length > 0) {
          display.classList.add("has-file");
          if (selectedFiles.length === 1) {
            fileName.textContent = selectedFiles[0].name;
          } else {
            fileName.textContent = `${selectedFiles.length} files selected`;
          }
        } else {
          display.classList.remove("has-file");
          fileName.textContent = "";
        }
      }

      function updateActionButtons() {
        const clearBtn = document.getElementById("clearBtn");
        const doneBtn = document.getElementById("doneBtn");
        const hasFiles = selectedFiles.length > 0;

        clearBtn.disabled = !hasFiles;
        doneBtn.disabled = !hasFiles;
      }

      function clearFileSelection() {
        selectedFiles = [];
        document.getElementById("fileInput").value = "";
        updateFileDisplay();
        updateActionButtons();
        hideUploadProgress();
        logToConsole("files", "üóëÔ∏è File selection cleared", null, "files");
        showToast("üßπ File selection cleared", "info");
      }

      async function uploadFiles() {
        if (
          selectedFiles.length === 0 ||
          !ws ||
          ws.readyState !== WebSocket.OPEN ||
          !currentStream
        ) {
          showToast(
            "‚ö†Ô∏è No files selected, no room selected, or WebSocket not connected",
            "warning"
          );
          return;
        }

        showUploadProgress();

        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          await uploadSingleFile(file, i + 1, selectedFiles.length);
        }

        hideUploadProgress();
        showToast(
          `üéâ Successfully uploaded ${selectedFiles.length} file(s)`,
          "success"
        );
        clearFileSelection();
      }

      async function clearSelectedStream() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          const clearMsg = {
            event: "clear",
            room_id: currentStream,
          };
          sendWebSocketMessage(clearMsg, true);
          logToConsole(
            "info",
            "üóëÔ∏è Sent clear audio to " + currentStream,
            { roomId: currentStream },
            "events"
          );
          showToast("üßπ Cleared audio stream", "info");
        }
      }

      async function sendStopSelectedStream() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          const stopMsg = {
            event: "stop",
            room_id: currentStream,
          };
          sendWebSocketMessage(stopMsg, true);
          logToConsole(
            "info",
            "‚èπÔ∏è Sent stop audio to " + currentStream,
            { roomId: currentStream },
            "events"
          );
          showToast("‚èπÔ∏è Stopped audio stream", "info");
        }
      }

      async function uploadSingleFile(file, index, total) {
        const totalChunks = Math.ceil(file.size / chunkSize);

        logToConsole(
          "files",
          `üì§ Uploading file: ${file.name} (${totalChunks} chunks)`,
          { name: file.name, size: file.size, type: file.type },
          "files"
        );

        for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
          const start = chunkIndex * chunkSize;
          const end = Math.min(start + chunkSize, file.size);
          const chunk = file.slice(start, end);

          const reader = new FileReader();
          reader.onload = function (e) {
            const base64Data = btoa(
              String.fromCharCode(...new Uint8Array(e.target.result))
            );

            const uploadMsg = {
              type: "audio-upload",
              roomId: currentStream,
              fileName: file.name,
              fileSize: file.size,
              fileType: file.type,
              chunkIndex: chunkIndex,
              totalChunks: totalChunks,
              chunkData: base64Data,
              isComplete: chunkIndex === totalChunks - 1,
            };

            sendWebSocketMessage(uploadMsg);
          };

          reader.readAsArrayBuffer(chunk);

          const progress =
            (((index - 1) * totalChunks + chunkIndex + 1) /
              (total * totalChunks)) *
            100;
          updateUploadProgress(progress);

          await new Promise((resolve) => setTimeout(resolve, 10));
        }
      }

      function handleFileUploadResponse(response) {
        if (response.success) {
          logToConsole(
            "files",
            `‚úÖ File upload successful: ${response.fileName}`,
            response,
            "files"
          );
        } else {
          logToConsole(
            "files",
            `‚ùå File upload failed: ${response.fileName} - ${response.error}`,
            response,
            "files"
          );
          showToast(`‚ùå Upload failed: ${response.error}`, "error");
        }
      }

      function showUploadProgress() {
        document.getElementById("uploadProgress").classList.add("show");
      }

      function hideUploadProgress() {
        document.getElementById("uploadProgress").classList.remove("show");
        updateUploadProgress(0);
      }

      function updateUploadProgress(percentage) {
        document.getElementById(
          "uploadProgressBar"
        ).style.width = `${percentage}%`;
      }

      // Room request popup
      function showRoomRequestPopup(roomData) {
        // if user in a room skip it
        if (currentStream) {
          return;
        }
        currentRoomRequest = roomData;

        playCallTone();

        document.getElementById("roomPopupName").textContent =
          roomData.name || "Unknown Room";
        document.getElementById(
          "roomPopupDetails"
        ).textContent = `üÜî Room ID: ${
          roomData.id || "N/A"
        }\n‚è∞ Time: ${new Date(roomData.timestamp).toLocaleString()}\n`;

        const overlay = document.getElementById("roomPopupOverlay");
        const popup = document.getElementById("roomPopup");

        overlay.classList.add("show");
        popup.classList.add("show");

        popupTimeout = setTimeout(dismissRoomPopup, 15000);

        logToConsole(
          "events",
          `üéâ Room request popup shown: ${roomData.name}`,
          roomData,
          "events"
        );
      }

      function acceptRoomRequest() {
        if (currentRoomRequest) {
          streamList.value = currentRoomRequest.id;
          streamList.dispatchEvent(new Event("change"));

          logToConsole(
            "success",
            `‚úÖ Accepted room request: ${currentRoomRequest.name}`,
            currentRoomRequest,
            "events"
          );
          showToast(
            `üéâ Room "${currentRoomRequest.name}" accepted!`,
            "success"
          );
        }

        dismissRoomPopup();
      }

      function dismissRoomPopup() {
        stopCallTone();
        const overlay = document.getElementById("roomPopupOverlay");
        const popup = document.getElementById("roomPopup");

        overlay.classList.remove("show");
        popup.classList.remove("show");

        if (popupTimeout) {
          clearTimeout(popupTimeout);
          popupTimeout = null;
        }

        setTimeout(() => {
          currentRoomRequest = null;
        }, 400);
      }

      // Upload settings popup
      function openUploadSettings() {
        const overlay = document.getElementById("uploadSettingsOverlay");
        const popup = document.getElementById("uploadSettingsPopup");
        document.getElementById("packetSize").value = chunkSize / 1024;

        overlay.classList.add("show");
        popup.classList.add("show");
      }

      function submitUploadSettings() {
        const packetSizeInput = document.getElementById("packetSize");
        const newSize = parseInt(packetSizeInput.value);
        if (newSize > 0) {
          chunkSize = newSize * 1024;
          showToast(`‚úÖ Packet size set to ${newSize} KB`, "success");
          logToConsole(
            "info",
            `‚öôÔ∏è Updated packet size to ${newSize} KB`,
            null,
            "files"
          );
        } else {
          showToast(`‚ö†Ô∏è Invalid packet size`, "warning");
        }
        dismissUploadSettings();
      }

      function dismissUploadSettings() {
        const overlay = document.getElementById("uploadSettingsOverlay");
        const popup = document.getElementById("uploadSettingsPopup");

        overlay.classList.remove("show");
        popup.classList.remove("show");
      }

      // Popup event listeners
      document
        .getElementById("roomPopupOverlay")
        .addEventListener("click", function (e) {
          if (e.target === this) dismissRoomPopup();
        });

      document
        .getElementById("uploadSettingsOverlay")
        .addEventListener("click", function (e) {
          if (e.target === this) dismissUploadSettings();
        });

      document.addEventListener("keydown", function (e) {
        if (
          e.key === "Escape" &&
          document.getElementById("roomPopupOverlay").classList.contains("show")
        ) {
          dismissRoomPopup();
        }
        if (
          e.key === "Escape" &&
          document
            .getElementById("uploadSettingsOverlay")
            .classList.contains("show")
        ) {
          dismissUploadSettings();
        }
      });

      // Window cleanup
      window.addEventListener("beforeunload", () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
        }
      });

      // Initialize application
      function initializeApp() {
        initializeWebSocket();
        updateActionButtons();

        setTimeout(() => {
          logToConsole(
            "success",
            "üöÄ Application initialized successfully",
            null,
            "events"
          );
          logToConsole(
            "websocket",
            "üåê WebSocket client ready",
            null,
            "websocket"
          );
          logToConsole(
            "audio",
            "üéµ Audio processing engine ready with packet upload support",
            null,
            "audio"
          );
          logToConsole("files", "üìÇ File upload system ready", null, "files");
          blinkDot2("disconnected");
        }, 100);
      }

      // Start application
      initializeApp();
    </script>
  </body>
</html>
