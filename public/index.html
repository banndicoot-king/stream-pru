<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Audio Streaming + Voice to Text</title>
    <style>
      body {
        display: flex;
        height: 100vh;
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }
      .stream-list {
        width: 250px;
        background-color: #f0f0f0;
        padding: 10px;
        overflow-y: auto;
      }
      h1, h2 {
        margin-top: 0;
      }
      select {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
      }
      .audio-player-container {
        flex-grow: 1;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .controls {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      #transcriptionBox {
        width: 100%;
        max-width: 600px;
        height: 150px;
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        overflow-y: auto;
      }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  </head>
  <body>
    <div class="stream-list">
      <h1>Live Audio</h1>
      <h2>Streams:</h2>
      <select id="streamSelect">
        <option value="">Select a stream</option>
      </select>
    </div>

    <div class="audio-player-container">
      <audio id="player" autoplay controls></audio>
      <div class="controls">
        <button onclick="startPay()">Start Stream</button>
        <button onclick="stopPay()">Stop Stream</button>
        <button onclick="startTranscription()">Start Transcription</button>
        <button onclick="stopTranscription()">Stop Transcription</button>
      </div>
      <div id="transcriptionBox">Transcription will appear here...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      const transcriptionBox = document.getElementById("transcriptionBox");

      // SpeechRecognition setup
      let recognition;
      let isRecognizing = false;

      if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = "en-US";

        recognition.onresult = (event) => {
          let transcript = "";
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            transcript += event.results[i][0].transcript;
          }
          transcriptionBox.innerText = transcript;
        };

        recognition.onerror = (event) => {
          console.error("Speech recognition error:", event.error);
        };

        recognition.onend = () => {
          isRecognizing = false;
          console.log("Speech recognition ended.");
        };
      } else {
        alert("Speech Recognition is not supported in your browser.");
      }

      function startTranscription() {
        if (recognition && !isRecognizing) {
          recognition.start();
          isRecognizing = true;
          transcriptionBox.innerText = "Listening...";
        }
      }

      function stopTranscription() {
        if (recognition && isRecognizing) {
          recognition.stop();
          isRecognizing = false;
        }
      }
    </script>

    <script>
      const ws = new WebSocket(
        window.location.protocol.replace("http", "ws") + "//" + window.location.host + "?ptpl=Ptpl123"
      );

      const streamList = document.getElementById("streamSelect");
      const audioElement = document.getElementById("player");
      const micControls = document.getElementById("micControls");

      let currentStream = null;
      let mediaSource = null;
      let sourceBuffer = null;
      let audioQueue = [];
      let isBuffering = false;
      let rooms = [];

      const startPay = async () => {
        if (!currentStream) {
          alert("Select a stream first");
          return;
        }
        try {
          const res = await fetch(`/audio/${currentStream}`, { method: "POST" });
          const data = await res.json();
          Toastify({ text: data.message || "Stream started", duration: 3000 }).showToast();
        } catch (err) {
          Toastify({ text: err.message || "Error starting stream", duration: 3000 }).showToast();
        }
      };

      const stopPay = async () => {
        if (!currentStream) return;
        try {
          const res = await fetch(`/audio/${currentStream}`, { method: "DELETE" });
          const data = await res.json();
          Toastify({ text: data.message || "Stream stopped", duration: 3000 }).showToast();
        } catch (err) {
          Toastify({ text: err.message || "Error stopping stream", duration: 3000 }).showToast();
        }
      };

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: "register-user", id: Date.now(), name: "test" }));
      };

      ws.onmessage = (event) => {
        const { type, ...message } = JSON.parse(event.data);

        if (type === "add-stream") {
          rooms = [...rooms, ...message.stream].map((r) => ({ ...r, id: r.id || r.roomId }));
          updateStreamList();
        } else if (type === "remove-stream") {
          rooms = rooms.filter((room) => room.id !== message.stream[0].roomId);
          updateStreamList();
        } else if (type === "audio-chunk2") {
          const binaryData = Uint8Array.from(atob(message.chunk.data), (c) => c.charCodeAt(0));
          const blob = new Blob([binaryData], { type: "audio/webm; codecs=opus" });
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.play();
        }
      };

      const updateStreamList = () => {
        const current = streamList.value;
        streamList.innerHTML = `<option value="">Select a stream</option>`;
        rooms.forEach((room) => {
          const option = document.createElement("option");
          option.value = room.id;
          option.textContent = room.name;
          streamList.appendChild(option);
        });
        if (current) streamList.value = current;
      };

      streamList.addEventListener("change", () => {
        const selected = streamList.value;
        if (selected !== currentStream) {
          stopStreaming();
          currentStream = selected;
          if (currentStream) {
            startStreaming();
          }
        }
      });

      const startStreaming = () => {
        ws.send(JSON.stringify({ type: "join-room", roomId: currentStream }));
        console.log("Joined stream:", currentStream);
      };

      const stopStreaming = () => {
        if (currentStream) {
          ws.send(JSON.stringify({ type: "leave-room", roomId: currentStream }));
          currentStream = null;
        }
      };
    </script>
  </body>
</html>
